# Memory Scramble

This repository implements the Spring 2025 **Memory Scramble** lab with a clean, testable structure:

- **Board ADT** (`src/board.ts`) holds all game state, rules, AF/RI/SRE, and `checkRep()` enforcement.
- **Commands module** (`src/commands.ts`) is a thin façade that *only* calls the Board’s methods.
- **HTTP server** (`src/server.ts`) exposes the REST API and **never** calls the Board directly.
- **Simulation** (`src/simulation.ts`) runs randomized concurrent players & watchers to catch deadlocks.
- **Tests** (`test/*.ts`) cover rules 1-A..1-D, 2-A..2-E, 3-A, 3-B, `mapAll`, and `watchOnce`.



## Start

```bash
npm install

npm start 8080 boards/perfect.txt

npm run test

npm run simulation
```


---

## Project Structure

```
src/
  board.ts        # Board ADT (mutable), AF/RI/SRE + checkRep()
  commands.ts     # thin façade over Board
  server.ts       # HTTP API (Express) -> only calls commands
  simulation.ts   # randomized N-player simulation + watchers

public/           # static web UI served by server.ts

test/
  board.rules.test.ts       # core rule coverage (1-*, 2-*, 3-A/3-B)
  board.watch-map.test.ts   # watchOnce & mapAll behavior
  helpers.ts

boards/           # sample board files (e.g., ab.txt, perfect.txt)

dist/             # compiled JS output (generated by tsc)
```


---

## HTTP API

All endpoints return **plain text** (`BOARD_STATE`) unless stated otherwise.

- `GET /look/:playerId`  
  Returns the board from `playerId`’s perspective.  
  `SPOT ::= none | down | up CARD | my CARD`

- `GET /flip/:playerId/:row,:column`  
  Performs a flip attempt according to the rules.  
  **200** → new `BOARD_STATE`. **409** → rule violation (1-A, 2-A, 2-B, bounds, bad id).

- `GET /replace/:playerId/:fromCard/:toCard`  
  Applies a map `f(x) = toCard if x==fromCard else x` to all cards, returns new `BOARD_STATE`.

- `GET /watch/:playerId`  
  Long-poll: fulfills when **any** change occurs (turn up/down, removal, or label change). Returns new `BOARD_STATE`.

---

## Board ADT (Specs, AF/RI/SRE)

### Abstraction Function (AF)
- `rows, cols` define a rectangular grid.
- `grid[r][c] === null` ⇒ empty spot (removed by **3-A**).
- `grid[r][c] = { card, faceUp, controller }` ⇒ a card with visibility and optional owner.
- `players[pid]` records:
  - `controlled`: 0..2 coordinates currently controlled by `pid`.
  - `lastFaceUps`: coordinates to flip down at `pid`’s next first flip (**3-B**).

### Representation Invariant (RI)
- `rows > 0`, `cols > 0`.
- `grid` is `rows × cols`, fully rectangular (no holes).
- If `faceUp === false` then `controller === null`.
- `controller` matches `/^[A-Za-z0-9_]+$/`.
- For every `pid` and coord ∈ `players[pid].controlled`: the grid spot exists, is `faceUp`, and `controller === pid`.

### Safety from Rep Exposure (SRE)
- Internal state is never exposed; only string snapshots (`BOARD_STATE`) leave the module.
- `mapAll()` mutates labels in place but does not leak references.
- `watchOnce()` resolves promises without exposing mutable internals.

### Key Operations

- `static parseFromFile(filename)`  
  **Requires**: file matches grammar.  
  **Effects**: reads file, constructs a fully face-down board.  
  **Throws**: on malformed header or illegal cards.

- `look(playerId)`  
  **Requires**: `playerId` matches `/^\w+$/`.  
  **Returns**: `BOARD_STATE` string from that player’s perspective.

- `flip(playerId, row, column)`  
  **Requires**: valid `playerId`, in-bounds coordinates.  
  **Behavior**: implements rules **1-A..1-D** and **2-A..2-E**; performs **3-A/3-B** *before* the next first flip.  
  **May Wait**: on 1-D (card face-up & controlled by another).  
  **Throws**: `no card at location` (1-A/2-A), `currently controlled` (2-B), `row/column out of bounds`, `invalid player id`.

- `mapAll(async f)`  
  **Requires**: `f(v)` returns a non-whitespace string.  
  **Effects**: for each **distinct** label `v`, computes `f(v)` once and replaces all occurrences atomically.  
  **Notifies**: all watchers if any replacement occurs.

- `watchOnce()`  
  **Returns**: a promise that fulfills when any card turns up/down, is removed, or its label changes. One-shot.

- `checkRep()`  
  **Effects**: throws if the RI is violated. Called after state changes.

### Concurrency & Waiting

- **1-D wait queues** per cell: if a player attempts to control a card that’s already controlled, they *wait*.  
- Waiters are **woken** when the card is relinquished (2-E) **or removed** (3-A).  
- **3-B** flips down prior mismatched face-ups at the *start* of the player’s next *first* flip.
- `watchOnce()` resolves on *any* change and is re-registered by clients as needed.

---

## Simulation

`src/simulation.ts` launches multiple players (random delays, random coordinates) plus optional watchers. The goal is to stress concurrency and ensure no deadlocks or crashes.

Output:

```bash
simulation finished without crashes
Players=4, MovesPerPlayer=100, Board=5x5
Flip attempts=800, successes=109, failures=691, elapsedMs=283
[player p0] moves=100, elapsedMs=278, successes=33, failures=167
[player p1] moves=100, elapsedMs=282, successes=29, failures=171
[player p2] moves=100, elapsedMs=274, successes=20, failures=180
[player p3] moves=100, elapsedMs=276, successes=27, failures=173
```

## Testing

Output:

```bash
✔ initial look shows all down (12.388717ms)
✔ 1-B first card turns up + controlled (my) (4.380067ms)
✔ 2-B fail: second card is currently controlled (same square) (2.818719ms)
✔ 1-C first card already up & uncontrolled => take control (2.491838ms)
✔ 1-D waiting: player waits while card controlled by another, resumes when relinquished (3.012085ms)
✔ 2-A second is empty -> fail; first remains up, uncontrolled (5.563926ms)
✔ 2-C turning second card face-up before evaluating match (3.521183ms)
✔ 2-E mismatch leaves both up & uncontrolled; 3-B flips them down at next first (2.827598ms)
✔ 3-A matched pair removed at next first (2.95848ms)
✔ 1-D: waiter resumes after mismatch frees control (7.855029ms)
✔ mapAll: replaces labels but preserves faceUp/controller state (2.924616ms)
✔ /Users/ion/Desktop/Archive/UniversityUTM/Y3/PR/pr_year3/lab3/dist/test/helpers.js (65.032649ms)
ℹ tests 12
ℹ suites 0
ℹ pass 12
ℹ fail 0
ℹ cancelled 0
ℹ skipped 0
ℹ todo 0
ℹ duration_ms 152.02063
```